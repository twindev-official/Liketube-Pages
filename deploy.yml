# File: .github/workflows/deploy.yml

# 1. Name of the workflow
name: Build and Deploy to GitHub Pages

# 2. When to run the workflow
on:
  # Run on pushes to the 'main' branch
  push:
    branches: [ "main" ]
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# 3. Set permissions
# These permissions are necessary for the workflow to deploy to Pages
permissions:
  contents: read
  pages: write
  id-token: write

# 4. Define the jobs
jobs:
  # First job: build the site
  build:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Check out your repository code so the workflow can use it
      - name: Checkout repository
        uses: actions/checkout@v4

      # ⬇️ *** THIS IS THE STEP TO CUSTOMIZE *** ⬇️
      # Step 2: Use the secret token to fetch data
      - name: Fetch API Data
        # This command uses your secret, fetches data, and saves it
        # The secret ${{ secrets.TOKEN }} is never printed or saved in the file.
        run: |
          # Create a directory for the data if it doesn't exist
          # (Common for Jekyll sites)
          mkdir -p _data
          
          # Use curl to call your API with the secret token and save the
          # response to a JSON file.
          #
          # ⚠️ CUSTOMIZE THIS LINE:
          #    - Replace "https://api.example.com/my-data" with your API's URL.
          #    - Replace "_data/posts.json" with where you want to save the data.
          curl -H "Authorization: Bearer ${{ secrets.TOKEN }}" \
               "https://api.github.com" \
               -o _data/posts.json
      # ⬆️ *** END OF CUSTOMIZATION *** ⬆️

      # Step 3: Configure GitHub Pages
      - name: Setup Pages
        uses: actions/configure-pages@v5

      # Step 4: Build your site (if necessary) & upload the artifact
      # This action automatically handles basic HTML, CSS, JS, and Jekyll sites.
      # It creates a folder called '_site' and uploads it.
      - name: Build with Jekyll or just prep static files
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site

      # Step 5: Upload the built site as an artifact
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # This is the folder that gets deployed
          path: ./_site

  # Second job: deploy the site
  deploy:
    # This job needs the 'build' job to finish first
    needs: build
    
    # Grant permissions for the deployment
    permissions:
      pages: write
      id-token: write
      
    # Run on a standard GitHub runner
    runs-on: ubuntu-latest
    
    # Use the official GitHub Pages deployment environment
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
      
    steps:
      # The official action to deploy the artifact to GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
