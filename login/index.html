<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Liketube</title>
    <!-- Fonts from main page -->
    <link href="https://fonts.googleapis.com/css2?family=Tahoma:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Icon from main page (assuming path relative to root) -->
    <link rel="icon" href="../icon.png">
    
    <style>
        /* Copied theme variables from index.html for consistency */
        :root {
            /* Light Mode (Default) - Classic Theme */
            --bg-color: #e6f0ff; /* Light blue background */
            --header-bg: linear-gradient(to bottom, #4267B2, #3b5998); /* Blue gradient header */
            --header-border: #365899;
            --header-text: #ffffff;
            --text-color: #000000;
            --text-color-secondary: #333;
            --primary-blue: #3b5998; /* Classic Facebook blue */
            --primary-blue-hover: #365899;
            --search-bg: #ffffff;
            --search-border: #ddd;
            
            /* Button Gradients */
            --btn-login-bg: linear-gradient(to bottom, #f0f8ff, #d6e8ff);
            --btn-login-hover-bg: linear-gradient(to bottom, #d6e8ff, #c0d9ff);
            --btn-login-border: var(--primary-blue);
            --btn-login-text: var(--primary-blue);
            
            --btn-signup-bg: linear-gradient(to bottom, #28a745, #218838);
            --btn-signup-hover-bg: linear-gradient(to bottom, #218838, #1e7e34);
            --btn-signup-border: #1e7e34;
            --btn-signup-text: #ffffff;

            /* Card styles */
            --card-bg: #ffffff;
            --card-shadow: 0 4px 12px rgba(0,0,0,0.1);
            --card-border: #ddd;
        }

        .dark-mode {
            /* Dark Mode - Classic Theme */
            --bg-color: #1a2233; /* Dark blue background */
            --header-bg: linear-gradient(to bottom, #2a4a8a, #243f7a); /* Dark blue gradient header */
            --header-border: #243f7a;
            --header-text: #e0e0e0;
            --text-color: #e0e0e0;
            --text-color-secondary: #aaaaaa;
            --primary-blue: #5890ff; /* Brighter blue for dark mode */
            --primary-blue-hover: #4267B2;
            --search-bg: #2c2c2c;
            --search-border: #444;
            
            /* Dark Mode Button Gradients */
            --btn-login-bg: linear-gradient(to bottom, #2c3a5e, #24304d);
            --btn-login-hover-bg: linear-gradient(to bottom, #24304d, #1e2840);
            --btn-login-border: var(--primary-blue);
            --btn-login-text: var(--primary-blue);

            /* Card styles */
            --card-bg: #2c2c2c;
            --card-shadow: 0 4px 12px rgba(0,0,0,0.3);
            --card-border: #444;
        }

        /* --- Base --- */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow-x: hidden;
        }

        body {
            font-family: 'Tahoma', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Align to top */
            padding-top: 5rem;
        }
        
        [dir="rtl"] body {
            font-family: 'Tajawal', 'Tahoma', sans-serif;
        }

        /* --- Login Container --- */
        .login-container {
            width: 100%;
            max-width: 420px;
            padding: 2rem;
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            text-align: center;
        }
        
        .logo {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-blue);
            text-decoration: none;
            margin-bottom: 0.5rem;
            display: inline-block;
        }
        
        .login-container h2 {
            font-size: 1.25rem;
            color: var(--text-color-secondary);
            font-weight: 400;
            margin-bottom: 2rem;
        }
        
        /* --- Form --- */
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .form-group {
            text-align: left;
        }
        
        .form-group label {
            display: block;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text-color-secondary);
        }
        
        .form-input {
            width: 100%;
            padding: 0.8rem 1rem;
            font-size: 1rem;
            font-family: 'Tahoma', sans-serif;
            color: var(--text-color);
            background-color: var(--search-bg);
            border: 1px solid var(--search-border);
            border-radius: 4px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .form-input:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 89, 152, 0.2);
        }
        
        .btn {
            border: none;
            padding: 0.8rem 1.2rem;
            border-radius: 4px; /* Reduced for classic look */
            cursor: pointer;
            font-weight: 700; /* Bolder for classic feel */
            font-family: 'Tahoma', sans-serif;
            text-decoration: none;
            font-size: 1rem;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .btn-login-submit {
            background-image: var(--btn-signup-bg); /* Using signup green for primary action */
            color: var(--btn-signup-text);
            border: 1px solid var(--btn-signup-border);
        }
        .btn-login-submit:hover {
            background-image: var(--btn-signup-hover-bg);
            transform: translateY(-2px);
        }
        .btn-login-submit:disabled {
            background-image: none;
            background-color: #999;
            border-color: #888;
            cursor: not-allowed;
            transform: none;
        }
        
        /* --- Message Area --- */
        #message-box {
            margin-top: 1.5rem;
            padding: 0.75rem;
            border-radius: 4px;
            font-weight: 500;
            display: none; /* Hidden by default */
        }
        
        #message-box.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        
        #message-box.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        /* --- Back Link --- */
        .back-link {
            margin-top: 1.5rem;
            font-size: 0.9rem;
            color: var(--primary-blue);
            text-decoration: none;
            display: inline-block;
        }
        .back-link:hover {
            text-decoration: underline;
        }

    </style>
</head>
<body>

    <div class="login-container">
        <a href="../index.html" class="logo">Liketube</a>
        <h2>Log in to your account</h2>

        <form class="login-form" id="login-form">
            <div class="form-group">
                <label for="username">Username</label>
                <input type-="text" id="username" class="form-input" required>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" class="form-input" required>
            </div>
            
            <button type="submit" class="btn btn-login-submit" id="login-button">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>
        </form>
        
        <div id="message-box"></div>
        
        <a href="../index.html" class="back-link">
            <i class="fas fa-arrow-left"></i> Back to Home
        </a>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- Theme detection from main page ---
            // Simple theme detection to match. Assumes 'auto' is default.
            const savedTheme = localStorage.getItem('theme') || 'auto';
            const osDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');

            function applyTheme(theme) {
                if (theme === 'dark') {
                    document.body.classList.add('dark-mode');
                } else { // 'light'
                    document.body.classList.remove('dark-mode');
                }
            }

            if (savedTheme === 'auto') {
                if (osDarkScheme.matches) {
                    applyTheme('dark');
                } else {
                    applyTheme('light');
                }
            } else {
                applyTheme(savedTheme);
            }
            
            // --- Language detection from main page ---
            const savedLang = localStorage.getItem('language') || 'en';
            document.documentElement.lang = savedLang;
            document.documentElement.dir = savedLang === 'ar' ? 'rtl' : 'ltr';
            
            // --- Login Logic ---
            const loginForm = document.getElementById('login-form');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const loginButton = document.getElementById('login-button');
            const messageBox = document.getElementById('message-box');
            
            // This is the path to the JSON file created by the GitHub Action
            // It's relative to this login/index.html file
            const ACCOUNTS_JSON_PATH = '../_data/Login/accounts.json';
            
            // A simple cache for the decoded accounts list
            let decodedAccountsList = null;
            
            /**
             * Fetches and decodes the accounts list from the server.
             * Caches the result to avoid re-fetching on multiple login attempts.
             */
            async function getDecodedAccounts() {
                if (decodedAccountsList) {
                    return decodedAccountsList;
                }
                
                try {
                    const response = await fetch(ACCOUNTS_JSON_PATH);
                    if (!response.ok) {
                        throw new Error(`Could not fetch accounts file. Status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // data.content is the Base64-encoded *content* of accounts.txt
                    if (!data.content) {
                        throw new Error('Invalid accounts file format: "content" field missing.');
                    }
                    
                    // Decode the Base64 string to get the plain text content
                    // atob() is the native browser function to decode Base64
                    const decodedText = atob(data.content);
                    decodedAccountsList = decodedText; // Cache it
                    return decodedAccountsList;
                    
                } catch (error) {
                    console.error('Error fetching or decoding accounts:', error);
                    showMessage('error', 'Login system error. Please try again later.');
                    return null; // Indicate failure
                }
            }
            
            /**
             * Handles the form submission
             */
            async function handleLogin(event) {
                event.preventDefault(); // Stop the form from submitting normally
                setLoading(true);
                
                const username = usernameInput.value;
                const password = password.value;
                
                if (!username || !password) {
                    showMessage('error', 'Please enter both username and password.');
                    setLoading(false);
                    return;
                }
                
                // 1. Get the decoded content of accounts.txt
                const accountsContent = await getDecodedAccounts();
                if (!accountsContent) {
                    // Error message was already shown by getDecodedAccounts()
                    setLoading(false);
                    return;
                }
                
                // 2. Create the plain text string from user input
                // Assuming the format in the file is "username:password"
                const userPlainText = `${username}:${password}`;
                
                // 3. Encode the user's plain text string to Base64
                // btoa() is the native browser function to encode to Base64
                const userBase64 = btoa(userPlainText);
                
                // 4. Check if the user's Base64 string exists in the accounts file
                // We check if the decoded file content (which is a big string,
                // possibly with multiple lines) includes the user's Base64 string.
                if (accountsContent.includes(userBase64)) {
                    // SUCCESS
                    showMessage('success', 'Login successful! Redirecting...');
                    // Redirect to the main page after a short delay
                    setTimeout(() => {
                        window.location.href = '../index.html';
                    }, 1500);
                } else {
                    // FAILURE
                    showMessage('error', 'Invalid username or password.');
                    setLoading(false);
                }
            }
            
            /**
             * Displays a message to the user
             * @param {'success' | 'error'} type - The type of message
             * @param {string} text - The message text
             */
            function showMessage(type, text) {
                messageBox.className = type;
                messageBox.textContent = text;
            }
            
            /**
             * Toggles the loading state of the login button
             * @param {boolean} isLoading - Whether to show loading state
             */
            function setLoading(isLoading) {
                loginButton.disabled = isLoading;
                if (isLoading) {
                    loginButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
                } else {
                    loginButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
                }
            }
            
            // Attach the submit event listener to the form
            loginForm.addEventListener('submit', handleLogin);
            
            // Pre-fetch the accounts file on page load for a faster login
            getDecodedAccounts();

        });
    </script>
</body>
</html>